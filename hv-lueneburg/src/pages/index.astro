---
import Layout from '~/layouts/PageLayout.astro';

import Hero2 from '~/components/widgets/Hero2.astro';
import StickyScorebar from '~/components/widgets/StickyScorebar.astro';
import DynamicContentFeed from '~/components/widgets/DynamicContentFeed.astro';
import Stats from '~/components/widgets/Stats.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Features2 from '~/components/widgets/Features2.astro';

import Features2 from '~/components/widgets/Features2.astro';

import { sanityClient } from 'sanity:client';
import { urlForImage } from '~/utils/images'; // Fallback falls Bildverarbeitung nötig

// Fetch Sanity Data
const sanityHomePage = await sanityClient.fetch(`*[_type == "homePage"][0]{
  ...,
  "heroImages": heroSlides[].asset->url,
  "galleryImages": gallery[].asset->url,
  "aboutImage": aboutSection.image.asset->url
}`);

const hp = sanityHomePage || {};
const heroText = hp.heroText || { tagline: 'Seit 1946', title: 'Dein Verein für <br class="hidden sm:block" /><em class="not-italic text-primary">Handball</em> in Lüneburg', subtitle: 'Von der Jugend bis zu den Aktiven — Teamgeist, Fairplay und Leidenschaft für den Handballsport.' };
const spielplanText = hp.spielplanSection || { title: 'Nächste Spiele', tagline: 'Spielplan', subtitle: 'Alle Heimspiele und Auswärtstermine des HV Lüneburg.' };
const statsSection = hp.statsText || { title: 'HV Lüneburg', tagline: 'In Zahlen', subtitle: 'Seit 1946 fester Bestandteil des Lüneburger Sports.' };
const teamsText = hp.teamsSection || { title: 'Unsere Teams', tagline: 'Mannschaften', subtitle: 'Von den Aktiven bis zur Jugend.' };
const tabellenText = hp.tabellenSection || { title: 'Aktuelle Tabellen', tagline: 'Tabelle', subtitle: 'Die Tabellen von 1. Herren und 1. Damen im Überblick.' };
const ctaText = hp.ctaSection || { title: 'Lust auf Handball?', subtitle: 'Schau bei einem Probetraining vorbei und lerne uns kennen. Wir freuen uns auf dich!' };
const aboutContent = hp.aboutSection || {
  eyebrow: 'Seit 1946 in Lüneburg',
  title: 'Handball, der <span class="text-primary">verbindet.</span>',
  text: 'Seit 1946 steht der HV Lüneburg für attraktiven Handball in Stadt und Landkreis.',
  buttonText: 'Mehr über den Verein erfahren',
  bullets: [
    { icon: 'tabler:heart-handshake', text: 'Starker Teamgeist auf und neben dem Feld' },
    { icon: 'tabler:shield-check', text: 'Gelebtes Fairplay in allen Ligen' },
    { icon: 'tabler:star', text: 'Aktive Jugendförderung' }
  ]
};

const clubStatsData = hp.clubStats || [
  { title: 'Mitglieder', amount: '250+', icon: 'tabler:users' },
  { title: 'Mannschaften', amount: '17', icon: 'tabler:ball-tennis' },
  { title: 'Jahre', amount: '79+', icon: 'tabler:calendar' },
  { title: 'Spiele / Saison', amount: '100+', icon: 'tabler:trophy' }
];

const galleryArray = hp.galleryImages || [
  'https://images.unsplash.com/photo-1548689816-c399f954f3dd?q=80&w=800&auto=format&fit=crop',
  'https://images.unsplash.com/photo-1574629810360-7efbb6b69281?q=80&w=800&auto=format&fit=crop',
  'https://images.unsplash.com/photo-1526676037777-05a232554f77?q=80&w=800&auto=format&fit=crop',
  'https://images.unsplash.com/photo-1518655048521-f130df041f66?q=80&w=800&auto=format&fit=crop'
];

const heroSlidesArray = (hp.heroImages && hp.heroImages.length > 0) ? hp.heroImages.map(url => ({ src: url, alt: 'Hero Image' })) : [
  { src: 'https://images.unsplash.com/photo-1550572017-55de7e1e9c63?q=80&w=1920&auto=format&fit=crop', alt: 'HV Lüneburg – Heimspiel' }
];

const sanityTeams = await sanityClient.fetch(`*[_type == "mannschaft"] | order(reihenfolge asc)`);
const widgetTeams = sanityTeams.length > 0 ? sanityTeams.slice(0, 6) : [];

const settings = await sanityClient.fetch(`*[_type == "siteSettings"][0]{handballNetSettings}`);
const hbConfigFromSanity = settings?.handballNetSettings || {};

import { sponsorStrip, nextMatch, handballNetSettings } from '~/data/site';
const hbConfig = handballNetSettings; // Use static config to fix widget init

// Format match date for display: "Sa., 15.03.2026 · 19:30 Uhr"
const matchDate = new Date(nextMatch.date);
const formattedMatchDate = matchDate.toLocaleDateString('de-DE', {
  weekday: 'short',
  day: '2-digit',
  month: '2-digit',
  year: 'numeric',
}) + ' · ' + matchDate.toLocaleTimeString('de-DE', {
  hour: '2-digit',
  minute: '2-digit',
}) + ' Uhr';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';
import { Icon } from 'astro-icon/components';

const metadata = {
  title: 'HV Lüneburg — Dein Handballverein in Lüneburg',
  ignoreTitleTemplate: true,
};

const bgGray = '<div style="position:absolute;inset:0;background:var(--color-gray-100);"></div>';

const mockPosts = [
  {
    id: '1', type: 'spielbericht', title: 'Derbysieg in letzter Sekunde!', date: '12. Nov 2026', author: 'Redaktion',
    imageUrl: 'https://images.unsplash.com/photo-1548689816-c399f954f3dd?q=80&w=1000&auto=format&fit=crop',
    excerpt: 'In einem unfassbaren Spiel dreht die 1. Herren einen 4-Tore-Rückstand in den letzten 5 Minuten und sichert sich den Derbysieg.',
    team: '1. Herren', score: '28 : 27', link: '/blog/derbysieg'
  },
  {
    id: '2', type: 'ankündigung', title: 'Neue Trainingszeiten für die E-Jugend', date: '10. Nov 2026',
    excerpt: 'Bitte beachtet die Hallenänderung ab kommender Woche Montag.',
    link: '/blog/trainingszeiten'
  },
  {
    id: '3', type: 'gallery', title: 'Saisonauftakt 2026', date: '01. Sep 2026',
    galleryImages: [
      'https://images.unsplash.com/photo-1574629810360-7efbb6b69281?q=80&w=1000&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1526676037777-05a232554f77?q=80&w=1000&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1518655048521-f130df041f66?q=80&w=1000&auto=format&fit=crop'
    ],
    link: '/blog/galerie-auftakt'
  }
];
---

<Layout metadata={metadata}>

  <StickyScorebar />

  <!-- 1. Hero -->
  <Hero2
    tagline={heroText.tagline}
    actions={[
      { variant: 'primary', text: 'Mehr erfahren', href: '/about', icon: 'tabler:arrow-right' },
      { text: 'Probetraining', href: '/contact', icon: 'tabler:ball-tennis' },
    ]}
    slides={heroSlidesArray}
  >
    <Fragment slot="title" set:html={heroText.title}></Fragment>
    <Fragment slot="subtitle" set:html={heroText.subtitle}></Fragment>
    <Fragment slot="fixture">
      <div class="fixture-card">
        <div class="fixture-card__eyebrow">
          <span class="badge badge--primary">Nächstes Spiel</span>
          <span class="fixture-card__league">{nextMatch.league}</span>
        </div>
        <div class="fixture-card__teams">
          <span class="fixture-card__team">...</span>
          <span class="fixture-card__vs">VS</span>
          <span class="fixture-card__team">...</span>
        </div>
        <div class="fixture-card__meta">
          <span class="fixture-card__date">Lade Spieldaten...</span>
          <span class="fixture-card__venue"></span>
        </div>
        <div class="fixture-card__countdown" id="hero-countdown" data-target="" aria-live="polite"></div>
        <a href={nextMatch.scheduleUrl} class="fixture-card__link">Spielplan ansehen →</a>
      </div>
    </Fragment>
  </Hero2>

  <!-- 2. Partner-Leiste (scrolling marquee) -->
  <div class="sponsor-logo-strip" role="region" aria-label="Unsere Partner">
    <span class="sponsor-logo-strip__label">Partner</span>
    <div class="sponsor-logo-strip__logos">
      <!-- Two copies of the track for seamless infinite scroll -->
      <div class="sponsor-logo-strip__track" aria-hidden="true">
        {sponsorStrip.map((s) => (
          <a class="sponsor-logo-strip__item" href={s.href} aria-label={s.name}>
            {s.src
              ? <img src={s.src} alt={s.name} class="h-6 w-auto object-contain" />
              : <>
                  <span class="sponsor-logo-strip__mark">{s.mark}</span>
                  <span class="sponsor-logo-strip__name">{s.name}</span>
                </>
            }
          </a>
        ))}
      </div>
      <div class="sponsor-logo-strip__track" aria-hidden="true">
        {sponsorStrip.map((s) => (
          <a class="sponsor-logo-strip__item" href={s.href} aria-label={s.name} tabindex="-1">
            {s.src
              ? <img src={s.src} alt={s.name} class="h-6 w-auto object-contain" />
              : <>
                  <span class="sponsor-logo-strip__mark">{s.mark}</span>
                  <span class="sponsor-logo-strip__name">{s.name}</span>
                </>
            }
          </a>
        ))}
      </div>
    </div>
  </div>

  <!-- 3. Spielplan -->
  <WidgetWrapper id="spielplan" containerClass="max-w-6xl mx-auto">
    <Headline title={spielplanText.title} tagline={spielplanText.tagline} subtitle={spielplanText.subtitle} />
    <div class="handball-wrapper">
      <div id="hb-vereins-spielplan"></div>
    </div>
  </WidgetWrapper>

  <!-- 4. Aktuelles -->
  <DynamicContentFeed posts={mockPosts} />

  <!-- 4.5. Galerie -->
  <section class="home-gallery">
    <div class="home-gallery__grid">
      {galleryArray.map((img, i) => (
        <div class="home-gallery__item">
          <img src={img} alt={`Galerie Bild ${i+1}`} loading="lazy" />
        </div>
      ))}
    </div>
  </section>

  <!-- 5. Stats -->
  <Stats
    isDark
    tagline={statsSection.tagline}
    title={statsSection.title}
    subtitle={statsSection.subtitle}
    stats={clubStatsData}
  />

  <!-- 6. Mannschaften -->
  <Features2
    id="teams"
    tagline={teamsText.tagline}
    title={teamsText.title}
    subtitle={teamsText.subtitle}
    columns={3}
    bg={bgGray}
    items={widgetTeams.map((team) => ({
      title: team.name,
      description: `${team.beschreibung || ''}`,
      icon: 'tabler:shirt-sport',
      callToAction: { text: 'Mehr erfahren', href: `/teams/${team.slug?.current || team.slug}` },
    }))}
  />

  <!-- 7. Tabellen -->
  <WidgetWrapper id="tabellen" containerClass="max-w-7xl mx-auto px-0 sm:px-4">
    <Headline title={tabellenText.title} tagline={tabellenText.tagline} subtitle={tabellenText.subtitle} />
    <div class="tables-view">
      <div class="tables-view__track">
        <div class="tables-view__item">
          <div class="handball-wrapper">
            <div class="handball-wrapper__label">1. Herren</div>
            <div id="hb-tabelle-herren1"></div>
          </div>
        </div>
        <div class="tables-view__item">
          <div class="handball-wrapper">
            <div class="handball-wrapper__label">1. Damen</div>
            <div id="hb-tabelle-damen1"></div>
          </div>
        </div>
      </div>
    </div>
  </WidgetWrapper>

  <!-- 8. Über uns -->
  <section id="about" class="relative bg-white dark:bg-[#141414] py-20 md:py-28 border-t border-gray-100 dark:border-[#2A2A2A] overflow-hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 relative z-10">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20 items-center">
        <!-- Text Content -->
        <div class="space-y-8 order-2 lg:order-1">
          <div>
            <span class="heading-eyebrow">{aboutContent.eyebrow}</span>
            <h2 class="section-title mt-2" set:html={aboutContent.title}></h2>
          </div>

          <p class="text-gray-600 dark:text-gray-400 text-lg leading-relaxed max-w-lg" set:html={aboutContent.text}></p>

          <ul class="space-y-4">
            {(aboutContent.bullets || []).map(({ icon, text }) => (
              <li class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary flex-shrink-0">
                  <Icon name={icon || 'tabler:check'} class="w-5 h-5" />
                </div>
                <span class="font-heading font-bold uppercase tracking-wide text-sm text-gray-900 dark:text-white">{text}</span>
              </li>
            ))}
          </ul>

          <div class="pt-4">
            <a href="/about" class="btn btn--primary btn--lg btn--pill">{aboutContent.buttonText || 'Mehr erfahren'}</a>
          </div>
        </div>

        <!-- Image -->
        <div class="relative order-1 lg:order-2">
          <div class="absolute -inset-4 bg-primary/5 rounded-3xl -z-10"></div>
          <div class="absolute -top-2 -right-2 w-24 h-24 border-4 border-primary/20 rounded-2xl -z-10"></div>
          <img
            src={hp.aboutImage || "https://images.unsplash.com/photo-1548689816-c399f954f3dd?q=80&w=800&auto=format&fit=crop"}
            alt="Über uns Bild"
            class="w-full rounded-2xl shadow-xl border border-gray-100 dark:border-[#2A2A2A] object-cover aspect-[4/3]"
          />
        </div>
      </div>
    </div>
  </section>

  <!-- 9. Call to Action -->
  <CallToAction
    actions={[
      { variant: 'primary', text: 'Kontakt aufnehmen', href: '/contact', icon: 'tabler:mail' },
    ]}
  >
    <Fragment slot="title" set:html={ctaText.title}></Fragment>
    <Fragment slot="subtitle" set:html={ctaText.subtitle}></Fragment>
  </CallToAction>

  <!-- handball.net Widget Script -->
  <script is:inline define:vars={{ hbConfig }}>
    (function(e,t,n,r,i,s,o){e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},
    e[i].l=1*new Date;s=t.createElement(n),o=t.getElementsByTagName(n)[0];s.async=1;
    s.src=r;o.parentNode.insertBefore(s,o)})(window,document,"script",
    'https://www.handball.net/widgets/embed/v1.js',"_hb");

    // Startseite Spielplan (alles)
    var spielplanOptions = { widget: 'spielplan', container: 'hb-vereins-spielplan' };
    if (hbConfig.clubId) spielplanOptions.clubId = hbConfig.clubId;
    if (hbConfig.organizationId) spielplanOptions.organizationId = hbConfig.organizationId;
    _hb(spielplanOptions);

    // Tabelle 1. Herren
    var tabelleHerrenOptions = { widget: 'tabelle', container: 'hb-tabelle-herren1' };
    if (hbConfig.clubId) tabelleHerrenOptions.clubId = hbConfig.clubId;
    if (hbConfig.tournamentIdHerren) tabelleHerrenOptions.tournamentId = hbConfig.tournamentIdHerren;
    if (hbConfig.teamIdHerren) tabelleHerrenOptions.teamId = hbConfig.teamIdHerren;
    _hb(tabelleHerrenOptions);

    // Tabelle 1. Damen
    if (hbConfig.tournamentIdDamen || hbConfig.teamIdDamen) {
      var tabelleDamenOptions = { widget: 'tabelle', container: 'hb-tabelle-damen1' };
      if (hbConfig.clubId) tabelleDamenOptions.clubId = hbConfig.clubId;
      if (hbConfig.tournamentIdDamen) tabelleDamenOptions.tournamentId = hbConfig.tournamentIdDamen;
      if (hbConfig.teamIdDamen) tabelleDamenOptions.teamId = hbConfig.teamIdDamen;
      _hb(tabelleDamenOptions);
    }
  </script>

  <!-- Countdown für das Nächste-Spiel-Kärtchen -->
  <script is:inline>
    (function () {
      var el = document.getElementById('hero-countdown');
      if (!el) return;
      var target = new Date(el.dataset.target).getTime();
      if (isNaN(target)) return;
      function update() {
        var diff = target - Date.now();
        if (diff <= 0) { el.textContent = 'Heute!'; return; }
        var d = Math.floor(diff / 86400000);
        var h = Math.floor((diff % 86400000) / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        el.textContent = 'Noch\u00A0' + d + 'T\u00A0' + h + 'h\u00A0' + m + 'm';
      }
      update();
      setInterval(update, 60000);
    })();
  </script>

  <!-- Auto-populate hero fixture card from handball.net Spielplan widget.
       Reads the first upcoming game once the widget renders and updates the
       static nextMatch card. Falls back silently if the widget hasn't loaded
       or class names change. -->
  <script is:inline>
    (function () {
      var CONTAINER = document.getElementById('hb-vereins-spielplan');
      if (!CONTAINER) return;

      function tryUpdate() {
        // Find the first game group/row
        var firstGroup = CONTAINER.querySelector('.hb-embed__schedule-list-grouped-item') || CONTAINER.querySelector('.hb-embed__schedule-entry');
        if (!firstGroup) return false;

        // --- 1. Extract Teams (Home & Guest) ---
        var teamEls = firstGroup.querySelectorAll('.hb-embed__schedule-list-item-team-name, .hb-embed__schedule-team');
        if (teamEls.length >= 2) {
          var homeName = teamEls[0].textContent.trim().replace('Handballverein', 'HV');
          var guestName = teamEls[teEls => teamEls.length - 1].textContent.trim().replace('Handballverein', 'HV');
          
          var uiTeams = document.querySelectorAll('.fixture-card__teams .fixture-card__team');
          if (uiTeams.length >= 2) {
            uiTeams[0].textContent = homeName;
            uiTeams[1].textContent = guestName;
          }
        } else if (teamEls.length === 1) {
          var guestEl = teamEls[0];
          var opponentEl = document.querySelector('.fixture-card__teams .fixture-card__team:last-child');
          if (opponentEl) opponentEl.textContent = guestEl.textContent.trim().replace('Handballverein', 'HV');
        }

        // --- 2. Extract Date & Time ---
        var dateEl = firstGroup.querySelector('.hb-embed__schedule-list-item-date, .hb-embed__schedule-date, .date');
        var timeEl = firstGroup.querySelector('.hb-embed__schedule-list-item-starts-at-time, .hb-embed__schedule-time, time');
        
        var dateText = dateEl ? dateEl.textContent.trim() : null;
        var timeText = timeEl ? timeEl.textContent.trim() : null;

        if (dateText) {
          var dateDisplay = document.querySelector('.fixture-card__date');
          
          // Clean texts for UI
          var cleanDateUI = dateText;
          if (timeText) {
             cleanDateUI += ' · ' + timeText;
          }
          if (dateDisplay) dateDisplay.textContent = cleanDateUI;

          // Compute ISO string for countdown
          // Extract matching parts from "Samstag, 28.2.2026" or "28.02.26"
          var dateMatch = dateText.match(/(\d{1,2})\.(\d{1,2})\.(\d{2,4})/);
          if (dateMatch) {
            var d = dateMatch[1].padStart(2, '0');
            var m = dateMatch[2].padStart(2, '0');
            var y = dateMatch[3].length === 2 ? '20' + dateMatch[3] : dateMatch[3];
            
            var t = '00:00';
            if (timeText) {
               var timeMatch = timeText.match(/(\d{1,2}:\d{2})/);
               if (timeMatch) t = timeMatch[1].padStart(5, '0');
            }
            
            var isoString = y + '-' + m + '-' + d + 'T' + t + ':00';
            var parsed = Date.parse(isoString);
            
            if (!isNaN(parsed)) {
              var countdown = document.getElementById('hero-countdown');
              if (countdown) countdown.dataset.target = new Date(parsed).toISOString();
            }
          }
        }

        return true;
      }

      // Watch for the widget to inject its HTML
      var observer = new MutationObserver(function (_, obs) {
        if (tryUpdate()) obs.disconnect();
      });
      observer.observe(CONTAINER, { childList: true, subtree: true });

      // Also try immediately in case it already rendered
      tryUpdate();

      // Disconnect after 15 s regardless to avoid memory leaks
      setTimeout(function () { observer.disconnect(); }, 15000);
    })();
  </script>

</Layout>
