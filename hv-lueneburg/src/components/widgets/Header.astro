---
import { Icon } from 'astro-icon/components';
import Logo from '~/components/Logo.astro';
import ToggleMenu from '~/components/common/ToggleMenu.astro';
import Button from '~/components/ui/Button.astro';

import { getHomePermalink } from '~/utils/permalinks';
import { trimSlash, getAsset } from '~/utils/permalinks';
import type { CallToAction } from '~/types';

interface Link {
  text?: string;
  href?: string;
  ariaLabel?: string;
  icon?: string;
}

interface MenuLink extends Link {
  links?: Array<MenuLink>;
}

export interface Props {
  id?: string;
  links?: Array<MenuLink>;
  actions?: Array<CallToAction>;
  isSticky?: boolean;
  isDark?: boolean;
  isFullWidth?: boolean;
  showToggleTheme?: boolean;
  showRssFeed?: boolean;
  position?: string;
}

const {
  id = 'header',
  links = [],
  actions = [],
  isSticky = false,
  isDark = false,
  isFullWidth = false,
  showToggleTheme = false,
  showRssFeed = false,
  position = 'center',
} = Astro.props;

const currentPath = `/${trimSlash(new URL(Astro.url).pathname)}`;
---

<header
  class="navbar not-prose"
  class:list={[{ sticky: isSticky, dark: isDark }]}
  {...isSticky ? { 'data-aw-sticky-header': true } : {}}
  {...id ? { id } : {}}
>
  <div class="navbar__inner" class:list={[{ 'max-w-[1440px]': !isFullWidth }]}>

    <!-- Logo -->
    <a class="navbar__logo" href={getHomePermalink()} aria-label="HV Lüneburg – Startseite">
      <Logo />
    </a>

    <!-- Desktop navigation -->
    <nav class="navbar__nav-wrapper" aria-label="Hauptnavigation">
      <ul class="navbar__nav" role="list">
        {
          links.map(({ text, href, links: subLinks }) => (
            <li class:list={['navbar__nav-item', subLinks?.length ? 'dropdown' : '']}>
              {subLinks?.length ? (
                <>
                  <button
                    type="button"
                    class="navbar__nav-link"
                    aria-expanded="false"
                    aria-haspopup="true"
                  >
                    {text}
                    <Icon name="tabler:chevron-down" class="w-3 h-3 ml-1 inline-block" />
                  </button>
                  <ul class="dropdown-menu navbar__dropdown" role="list">
                    {subLinks.map(({ text: text2, href: href2 }) => (
                      <li>
                        <a
                          class:list={[
                            'navbar__dropdown-link',
                            { 'navbar__nav-link--active': href2 === currentPath },
                          ]}
                          href={href2}
                        >
                          {text2}
                        </a>
                      </li>
                    ))}
                  </ul>
                </>
              ) : (
                <a
                  class:list={[
                    'navbar__nav-link',
                    { 'navbar__nav-link--active': href === currentPath },
                  ]}
                  href={href}
                >
                  {text}
                </a>
              )}
            </li>
          ))
        }
      </ul>
    </nav>

    <!-- Right side: Probetraining CTA + mobile toggle -->
    <div class="navbar__cta">
      <!-- RSS Feed (desktop, optional) -->
      {showRssFeed && (
        <a
          class="hidden md:flex items-center justify-center w-9 h-9 text-gray-400 hover:text-white transition-colors"
          aria-label="RSS Feed"
          href={getAsset('/rss.xml')}
        >
          <Icon name="tabler:rss" class="w-5 h-5" />
        </a>
      )}

      <!-- Any extra actions from navigation.ts -->
      {actions?.length ? (
        <div class="hidden md:flex items-center gap-2">
          {actions.map((btnProps) => (
            <Button {...btnProps} class="btn btn--primary btn--sm btn--pill" />
          ))}
        </div>
      ) : null}

      <!-- Hardcoded Probetraining CTA (always shown on desktop) -->
      <a href="/contact" class="navbar__probetraining hidden md:inline-flex btn btn--primary btn--sm btn--pill">
        Probetraining
      </a>

      <!-- Dark/light mode toggle (always visible) -->
      <button
        class="theme-toggle"
        aria-label="Erscheinungsbild umschalten"
        data-aw-toggle-color-scheme
      >
        <!-- Sun icon: shown in dark mode -->
        <svg class="icon-sun w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
        </svg>
        <!-- Moon icon: shown in light mode -->
        <svg class="icon-moon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>

      <!-- Mobile hamburger -->
      <div class="flex md:hidden items-center gap-2">
        <ToggleMenu />
      </div>
    </div>

  </div>
</header>

<script is:inline>
  (function () {
    var nav = document.getElementById('header');
    if (!nav) return;
    function onScroll() {
      nav.classList.toggle('navbar--scrolled', window.scrollY > 8);
    }
    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
  })();
</script>

<style>
  /* ---- Navbar overrides using HVL design system ----------------------- */

  .navbar {
    top: 0;
    z-index: var(--z-sticky, 200);
    transition: box-shadow 300ms ease;
    /* Always keep the HVL black background — never let bg-page override it */
    background-color: var(--color-black, #0C0C0C) !important;
  }

  .navbar.sticky {
    position: sticky;
  }

  /* bg-page is toggled by AstroWind's menu script — override it */
  .navbar.bg-page {
    background-color: var(--color-black, #0C0C0C);
  }

  .navbar--scrolled {
    box-shadow: none;
  }

  /* Default logo color before mobile menu expansions */
  .navbar__logo-text {
    color: var(--color-white, #fff) !important;
  }

  /* Desktop nav wrapper — hidden on mobile */
  .navbar__nav-wrapper {
    display: none;
    width: max-content; 
  }

  @media (min-width: 768px) {
    .navbar__nav-wrapper {
      display: flex;
      align-items: center;
      flex: 1;
      justify-content: center;
    }
  }

  /* Dropdown */
  .navbar__dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    min-width: 200px;
    background-color: var(--color-gray-800, #1a1a1a);
    border: 1px solid var(--color-gray-700, #2a2a2a);
    border-top: 3px solid var(--color-primary, #E30613);
    border-radius: 0 0 var(--radius-md, 8px) var(--radius-md, 8px);
    list-style: none;
    padding: var(--space-2, 0.5rem) 0;
    margin: 0;
    z-index: var(--z-dropdown, 100);
    box-shadow: var(--shadow-lg);
  }

  .navbar__dropdown-link {
    display: block;
    padding: var(--space-3, 0.75rem) var(--space-5, 1.25rem);
    font-family: var(--font-display, 'Barlow Condensed');
    font-size: var(--, 0.875rem);
    font-weight: var(--fw-bold, 700);
    letter-spacing: var(--ls-wide, 0.05em);
    text-transform: uppercase;
    color: var(--color-gray-300, #ccc);
    text-decoration: none;
    transition: color var(--transition-fast), background-color var(--transition-fast);
  }

  .navbar__dropdown-link:hover {
    color: var(--color-white, #fff);
    background-color: rgba(255, 255, 255, 0.06);
    text-decoration: none;
  }

  /* style.css hides .navbar__cta on mobile — restore it so the hamburger shows */
  @media (max-width: 767px) {
    .navbar__cta {
      display: flex;
    }
    :global(#header.expanded) .navbar__cta {
      z-index: 300; /* Ensure toggle button is above the mobile menu overlay */
      position: relative;
    }
  }

  /* Mobile expanded nav */
  @media (max-width: 767px) {
    /* 1. Header takes over background but keeps its natural layout rules (max-w, padding) */
    :global(header#header.expanded),
    :global(header#header.expanded.scroll),
    :global(header#header.expanded.navbar--scrolled) {
      box-shadow: none !important;
      border: none !important;
      background-color: var(--color-white, #fff) !important; /* Base Light Mode */
    }

    /* Transparent sub-containers so the main header bg shows through */
    :global(header#header.expanded .navbar__inner),
    :global(header#header.expanded .navbar__cta),
    :global(header#header.expanded .navbar__logo),
    :global(header#header.expanded .navbar__nav-wrapper),
    :global(header#header.expanded .navbar__nav) {
      background-color: transparent !important;
    }

    /* Light Mode Logo & Cross explicitly black */
    :global(html:not(.dark) header#header.expanded .navbar__logo-text),
    :global(html:not(.dark) header#header.expanded a.navbar__logo .navbar__logo-text),
    :global(html:not(.dark) header#header.expanded .sr-only) {
      color: var(--color-black, #0C0C0C) !important;
    }
    :global(html:not(.dark) header#header.expanded .navbar__logo-text span),
    :global(html:not(.dark) header#header.expanded a.navbar__logo .navbar__logo-text span) {
      color: var(--color-primary, #E30613) !important;
    }
    :global(html:not(.dark) header#header.expanded [data-aw-toggle-menu] span.toggle-line),
    :global(html:not(.dark) header#header.expanded button[data-aw-toggle-menu] span.toggle-line) {
      background-color: var(--color-black, #0C0C0C) !important;
    }
    :global(html:not(.dark) header#header.expanded .theme-toggle),
    :global(html:not(.dark) header#header.expanded button.theme-toggle) {
      color: var(--color-black, #0C0C0C) !important;
    }

    /* Light Mode Nav Links explicitly red */
    :global(html:not(.dark) header#header.expanded .navbar__nav-link),
    :global(html:not(.dark) header#header.expanded .navbar__dropdown-link) {
      color: var(--color-primary, #E30613) !important;
    }

    /* 3. Dark Mode Explicit Colors */
    :global(html.dark header#header.expanded),
    :global(html.dark header#header.expanded.scroll),
    :global(html.dark header#header.expanded.navbar--scrolled) {
      background-color: var(--color-black, #0C0C0C) !important;
    }
    :global(html.dark header#header.expanded .navbar__nav-link),
    :global(html.dark header#header.expanded .navbar__dropdown-link),
    :global(html.dark header#header.expanded .navbar__logo-text) {
      color: var(--color-white, #fff) !important;
    }
    :global(html.dark header#header.expanded .navbar__logo-text span) {
      color: var(--color-primary, #E30613) !important;
    }
    :global(html.dark header#header.expanded [data-aw-toggle-menu] span),
    :global(html.dark header#header.expanded button[data-aw-toggle-menu] span) {
      background-color: var(--color-white, #fff) !important;
    }
    :global(html.dark header#header.expanded .theme-toggle),
    :global(html.dark header#header.expanded button.theme-toggle) {
      color: var(--color-white, #fff) !important;
    }

    /* 4. The Nav Wrapper absolute positions below the 72px navbar inner to perfectly vertically center */
    :global(header#header.expanded .navbar__nav-wrapper) {
      display: flex !important;
      position: absolute;
      top: 72px; /* Starts exactly below the logo/cross line */
      left: 50% !important;
      transform: translateX(-50%) !important;
      bottom: 0; /* Stretches to bottom of screen */
      height: calc(100vh - 72px); /* Ensures it perfectly fills screen below header line */
      width: 100vw !important; /* Force full width to center items properly, overriding desktop max-content */
      flex-direction: column;
      align-items: center;
      justify-content: center; /* True vertical center! */
      overflow-y: auto;
      box-shadow: none !important;
      border: none !important;
      border-top: none !important;
      z-index: 10;
    }

    :global(header#header.expanded .navbar__nav) {
      display: flex !important;
      flex-direction: column;
      width: 100%;
      align-items: center;
      justify-content: center; 
      gap: 0; /* Let padding handle spacing */
      padding: 0 !important;
      margin: 0 !important;
      border-top: none !important;
    }

    :global(header#header.expanded .navbar__nav-link) {
      font-size: clamp(2rem, 8vw, 2.5rem);
      font-weight: 900;
      line-height: 1.1; 
      letter-spacing: normal !important; 
      text-transform: uppercase;
      white-space: normal; 
      text-align: center;
      padding: var(--space-2, 0.5rem) var(--space-4, 1rem); 
      border-bottom: none !important;
      border-top: none !important;
      width: 100%;
      border-radius: 12px;
      transition: background-color 200ms ease, color 200ms ease;
    }

    /* --- Mobile Menu Cascading Animation --- */
    @keyframes fadeInUpMobile {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    :global(header#header.expanded .navbar__nav-item) {
      opacity: 0;
      animation: fadeInUpMobile 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* Staggered animation delays for up to 8 menu items */
    :global(header#header.expanded .navbar__nav-item:nth-child(1)) { animation-delay: 50ms; }
    :global(header#header.expanded .navbar__nav-item:nth-child(2)) { animation-delay: 100ms; }
    :global(header#header.expanded .navbar__nav-item:nth-child(3)) { animation-delay: 150ms; }
    :global(header#header.expanded .navbar__nav-item:nth-child(4)) { animation-delay: 200ms; }
    :global(header#header.expanded .navbar__nav-item:nth-child(5)) { animation-delay: 250ms; }
    :global(header#header.expanded .navbar__nav-item:nth-child(6)) { animation-delay: 300ms; }
    :global(header#header.expanded .navbar__nav-item:nth-child(7)) { animation-delay: 350ms; }
    :global(header#header.expanded .navbar__nav-item:nth-child(8)) { animation-delay: 400ms; }

    :global(header#header.expanded .navbar__nav-link:hover) {
      background-color: rgba(227, 6, 19, 0.12);
      color: var(--color-primary, #E30613) !important;
    }

    :global(html.dark header#header.expanded .navbar__nav-link:hover) {
      background-color: rgba(255, 255, 255, 0.12);
      color: var(--color-white, #fff) !important;
    }

    :global(header#header.expanded .navbar__nav-link--active) {
      color: var(--color-primary, #E30613) !important;
    }

    :global(html.dark header#header.expanded .navbar__nav-link--active) {
      color: var(--color-white, #fff) !important;
    }

    /* Remove the red active line/border under the links in mobile view */
    :global(header#header.expanded .navbar__nav-link::after),
    :global(header#header.expanded .navbar__nav-link--active::after) {
      display: none !important;
      content: none !important;
    }

    /* Probetraining CTA visible in mobile menu */
    :global(#header.expanded .navbar__cta-mobile-extra) {
      display: flex;
      margin-top: var(--space-8, 2rem);
      width: 100%;
      justify-content: center;
    }

    :global(#header.expanded .navbar__dropdown) {
      position: static;
      border: none;
      margin-top: var(--space-2, 0.5rem);
      background: transparent;
      box-shadow: none;
      text-align: center;
    }

    :global(#header.expanded) .navbar__dropdown-link {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.1rem;
      padding: var(--space-2, 0.5rem) var(--space-4, 1rem);
    }

    :global(#header.expanded) .navbar__dropdown-link:hover {
      color: var(--color-primary, #E30613);
      background-color: rgba(227, 6, 19, 0.08);
    }
  }
</style>
